<html>
<header>
    {% include 'header.html' %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='ace-builds/src-noconflict/ace.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.19.0/full/pyodide.js"></script>
    <style type="text/css" media="screen">
 
    #editor, .jsonEditor, #output { 
        border: 1px solid lightgray;
		margin: auto;
		height: 200px;
		width: 80%;
    }
  </style> 
</header>
<body>

    {% include 'menu.html' %}
    
    <form id="checker">
        <input type="hidden" name="id" id="id" value="{{checker[0]}}" />
        <label for="code" class="col-form-label">Write your code</label><br />
        <div id="editor">{{checker[1]}}</div>
        <textarea cols="60" rows="16" name="desc" id="desc" style="display: none;">{{checker[1]}}</textarea><br />
        <label class="col-form-label">Select your datasources </label><br />
        {% for ds in datasources %}
            <input type="checkbox" {{ 'checked' if ds[1] in selected_datasources else 'Continue' }} name="datasources" value="{{ds[1]}}" /> {{ds[0]}} <br />
        {% endfor %}
        <hr />
        <div>
            <label class="col-form-label">Input your test cases (todo: in the future persist the tests)</label>
            <div class="testCase">
                <label class="col-form-label">Mock your dataset</label>
                <div class="jsonEditor" id="jsonEditor">{'dataSetExample': [{'name': 'Maria'}]}</div>
                <br />
                <label class="col-form-label">Output</label><br />
                <textarea id="output" style = "margin-left: 130px;"></textarea>
<br /> <br /> <br /> 

            </div>
            
            <input type="button" value="Run tests" onclick="evaluateTest()" class="btn btn-secondary" />
        </div>
        <hr />
        <input type="submit" class="btn btn-primary" />
    </form>
    {% if executions != None %}
        <table class="table">
            <tr>
                <td>Executed at</td>
                <td>Status</td>
            </tr>
            {% for execution in executions %}
                <tr>
                    <td>{{execution[0]}}</td>
                    <td>{{execution[1]}}</td>
                </tr>
            {% endfor %}
    {% endif %}



    <script type="text/javascript">
    $(document).ready(function() {
        var editor = ace.edit("editor");
        editor.session.setMode("ace/mode/python");
    
        // :C terrible, but ok for now
        window.tests = ace.edit("jsonEditor");
        tests.session.setMode("ace/mode/python");


        var textarea = $('textarea[name="desc"]');
        editor.getSession().on("change", function () {
            textarea.val(editor.getSession().getValue());
        });


        $('#checker').submit(function() {

            let datasources = $('input:checkbox:checked').map(function() {
                                    return this.value;
                                }).get();
            $.post({
                "url": '/api/checker/' + $('#id').val(),
                "dataType": "json",
                "data": JSON.stringify({'desc': $('#desc').val(), 'datasources': datasources}),
                "success": function(data, textStatus) {
                    console.log(data)
                    console.log(textStatus)
                    alert('Your datasource was inserted: id ' + data['id'])
                },
                "error" : function() {
                    alert('An error occurred :C')
                }
            })
            return false;
        })

    })

    function evaluateTest() {
        runPythonCode($('textarea[name="desc"]').val(), window.tests.getSession().getValue()) 

    }
    async function main() {
        let pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.19.0/full/",
        });
        output.value = "Ready!\n";
        return pyodide;
      }
      let pyodideReadyPromise = main();

      async function evaluatePython(code) {
        let pyodide = await pyodideReadyPromise;
        try {
          let output = pyodide.runPython(code);
          addToOutput(output);
        } catch (err) {
          addToOutput(err);
        }
      }

    function addToOutput(message) {
        $('#output').val(message)
    }

    // This is far from ideal, just a poc for now
    function runPythonCode(code, datasets) {
        let datasetscode = `datasets = ${datasets}`;
        let complete_code = `
class FailedAssertion(Exception):
    pass
class CheckerCase:

    def assertEmpty(self, collection, message):
        return self.assertLessThan(collection, 1, message)

    def assertEqual(self, first_item, second_item, message):
        return self.assertTrue(first_item == second_item, message)

    def assertLessThan(self, collection, max_size, message):
        return self.assertTrue(len(collection) < max_size, message)

    def assertGreaterThan(self, collection, size, message):
        return self.assertTrue(len(collection) > size, message)

    def assertFalse(self, expression, message):
        return self.assertTrue(not expression, message)

    def assertTrue(self, expression, message):
        if not expression:
            return message
        else:
            return "Test passed :)"
${datasetscode}
${code}
        `;
        evaluatePython(complete_code)

    }

    </script>

</body>
</html>
